<html>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
        crossorigin="anonymous"></script>

    <script>
        document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=2"></' + 'script>')
    </script>
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
    <script src="graphics.js"></script>
    <script>
        function downloadAsPng() {
            document.getElementById("downloader").download = "image.png";
            document.getElementById("downloader").href = document.getElementById("rf-canvas").toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
        }
        function addLayer() {
            let n_layers = parseInt(localStorage.getItem('n_layers'));
            if (isNaN(n_layers)) {
                n_layers = 0;
            }
            n_layers += 1;

            let kernel = parseInt(document.getElementById('textKernelSize').value);
            let stride = parseInt(document.getElementById('textStride').value);
            let padding = parseInt(document.getElementById('textPadding').value);
            let dilation = parseInt(document.getElementById('textDilation').value);
            let layer_info = JSON.stringify({ "kernel": kernel, "stride": stride, 'padding': padding, 'dilation': dilation });
            let layer_name = 'layer' + n_layers;

            localStorage.setItem(layer_name, layer_info);
            localStorage.setItem('n_layers', n_layers);
        }

        function resetLayer(cmd) {
            if (cmd == 'ALL') {
                localStorage.clear();
            } else if (cmd == 'LAST') {
                let n_layers = parseInt(localStorage.getItem('n_layers'));
                if (!isNaN(n_layers) && n_layers > 0) {
                    localStorage.removeItem('layer' + n_layers)
                    n_layers -= 1;
                    localStorage.setItem('n_layers', n_layers);
                    if (n_layers == 0) {
                        resetLayer('ALL');
                    }
                }
            } else {
                console.warn('Unknown resetLayer command:', cmd)
            }
            updateTable();
        }
        function clearTable() {
            document.getElementById('layerTable').innerHTML = '';
        }
        function updateTable() {
            clearTable();
            let n_layers = parseInt(localStorage.getItem('n_layers'));
            if (isNaN(n_layers)) {
                return
            }
            let layer_colors = JSON.parse(localStorage.getItem('layer_colors'));
            let headers = ['Layer #', 'Kernel', 'Stride', 'Padding', 'Dilation', 'In size', 'Out size', 'Receptive Field'];
            let tbl = document.createElement('table');
            tbl.className = 'table table-striped';
            let tbody = document.createElement('tbody');
            for (let layer = 0; layer < n_layers + 1; layer++) {
                if (layer == 0) {
                    let thead = document.createElement('thead');
                    // thead.className = 'thead-striped';
                    let tr = document.createElement('tr');
                    headers.forEach(head => {
                        let th = document.createElement('th');
                        th.appendChild(document.createTextNode(head));
                        tr.appendChild(th);
                    });
                    thead.appendChild(tr);
                    tbl.appendChild(thead);
                } else {
                    // var tr = tbl.insertRow();
                    let net = JSON.parse(localStorage.getItem('layer' + layer));
                    let tr = document.createElement('tr');
                    tr.style.color = 'white';
                    tr.style.backgroundColor = layer_colors[(layer - 1) % layer_colors.length];
                    headers.forEach(head => {
                        let td = tr.insertCell();
                        let text = '';
                        switch (head) {
                            case 'Layer #':
                                text = layer;
                                break;
                            case 'Kernel':
                                text = net.kernel;
                                break;
                            case 'Stride':
                                text = net.stride;
                                break;
                            case 'Padding':
                                text = net.padding;
                                break;
                            case 'Dilation':
                                text = net.dilation;
                                break;
                            case 'Receptive Field':
                                text = net.receptive_field;
                                break;
                            case 'In size':
                                text = net.in_size;
                                break;
                            case 'Out size':
                                text = net.out_size;
                                break;

                        }
                        td.appendChild(document.createTextNode(text));
                        tr.append(td);
                    });
                    tbody.appendChild(tr);
                }
            }
            tbl.appendChild(tbody);
            layerTable.appendChild(tbl);
        }
        function tableKeyDown() {
            if (event.key === 'Enter') {
                addLayer(); update(); updateTable();
            }
        }
    </script>
    <script src="rf.js"></script>
</head>

<body onload="update();">
    <header>
        <div class="navbar navbar-dark bg-dark box-shadow">
            <div class="container d-flex justify-content-between">
                <a href="#" class="navbar-brand d-flex align-items-center">
                    <strong>Visualizing Receptive Field</strong>
                </a>
                <li><a href="https://github.com/jojonki/Receptive-Field/" class="text-white">Go back to GitHub</a>
            </div>
        </div>
    </header>
    <div id="layers">

    </div>

    <div class="container">
        <hr>
        <div class="row">
            <div class="col">
                <!-- INPUT SIZE -->
                <label class="form-label">INPUT SIZE</label>
                <input class="form-control" id="textInputSize" value=30 onChange="update();">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label class="form-label">KERNEL</label>
                <input class="form-control" id="textKernelSize" value=3 onkeydown="tableKeyDown();">
            </div>
            <div class="col">
                <label class="form-label">STRIDE</label>
                <input class="form-control" id="textStride" value=2 onkeydown="tableKeyDown();">
            </div>
            <div class="col">
                <label class="form-label">PADDING</label>
                <input class="form-control" id="textPadding" value=2 onkeydown="tableKeyDown();">
            </div>
            <div class="col">
                <label class="form-label">DILATION</label>
                <input class="form-control" id="textDilation" value=1 onkeydown="tableKeyDown();">
            </div>
        </div>

        <div class="row" style="margin-top:0.5em">
            <div class="col">
                <button type="submit" class="btn btn-primary" onClick="addLayer(); update(); updateTable();">Add
                    Layer</button>
                <button type="submit" class="btn btn-danger" onClick="resetLayer('ALL'); update(); updateTable();">Reset
                    Network</button>
                <button type="submit" class="btn btn-warning"
                    onClick="resetLayer('LAST'); update(); updateTable();">Remove Layer
                </button>
                <a href="#" id="downloader" class="btn btn-info" onclick="downloadAsPng()" download="image.png">Download
                    as PNG</a>
            </div>
        </div>
        <div class="row" style="margin-top:0.5em">
            <div id="layerTable" class="col"></div>
        </div>

        <div class="row">
            <canvas id="rf-canvas" width="1140" height="1920"></canvas>
        </div>
    </div>
</body>

</html>